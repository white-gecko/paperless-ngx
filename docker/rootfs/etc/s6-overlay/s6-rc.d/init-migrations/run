#!/command/with-contenv bashio
# shellcheck shell=bash

local -r data_dir="${PAPERLESS_DATA_DIR:-/usr/src/paperless/data}"

(
	# flock is in place to prevent multiple containers from doing migrations
	# simultaneously. This also ensures that the db is ready when the command
	# of the current container starts.
	flock 200
	bashio::log.info "Apply database migrations..."
	python3 manage.py migrate --skip-checks --no-input
) 200>"${data_dir}/migration_lock"
